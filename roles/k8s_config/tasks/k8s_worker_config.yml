---
# Precheck validation
- name: Validate new worker node
  become: true
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kube_config_set

- name: Set skip for configured nodes
  set_fact:
    skip_config: "{{ kube_config_set.stat.exists }}"
  when: kube_config_set.stat.exists

- name: Notify user of existing configuration
  debug:
    msg: "Kubernetes worker already configured. Skipping configuration."
  when: kube_config_set.stat.exists

- name: Detect second disk device
  ansible.builtin.shell: |
    lsblk -dpno NAME | grep -vE 'boot|root|part' | grep -v $(lsblk -dpno NAME | grep -m1 -E 'vda|sda')
  register: second_disk
  changed_when: false

- name: Format second disk with ext4
  ansible.builtin.filesystem:
    fstype: ext4
    dev: "{{ second_disk.stdout }}"
  when: second_disk.stdout != ""

- name: Create mount point
  ansible.builtin.file:
    path: /mnt/longhorn
    state: directory
    mode: '0750'

- name: Mount second disk
  ansible.builtin.mount:
    path: /mnt/longhorn
    src: "{{ second_disk.stdout }}"
    fstype: ext4
    state: mounted
  when: second_disk.stdout != ""

- name: Set join command if not already set
  set_fact:
    join_command: "{{ lookup('aws_ssm', '/ansible/k8s/' + (proxmox_name | regex_replace('\\d+$', '')) + '-join-command', region='us-west-2', decrypt='true') }}"
  when: join_command is not defined

# - name: DEBUG - Display join command
#   debug:
#     msg: 
#       join_command: "{{ join_command }}"

# Add k8s worker nodes to the cluster
- name: Add new worker to the cluster
  become: true
  command: "{{ join_command }} --cri-socket unix:///run/containerd/containerd.sock"
  when:
  - skip_config is not defined